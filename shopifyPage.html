<!--
 * @Description: 
 * @Version: 2.0
 * @Author: Yaowen Liu
 * @Date: 2021-07-27 09:47:50
 * @LastEditors: Yaowen Liu
 * @LastEditTime: 2021-07-30 09:47:56
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
  <!-- <script type="text/javascript" src="https://static.filestackapi.com/filestack-js/1.x.x/filestack.min.js"></script> -->
  <!-- <script async src="https://sdk.amazonaws.com/js/aws-sdk-2.666.0.min.js" async></script> -->
  <script src="https://unpkg.com/vue@next"></script>
  <script src="./dist/my-lib.umd.js"></script>
  <link rel="stylesheet" href="./src/styles/normalize.css">
  <link rel="stylesheet" href="./dist/style.css">
  <style>
    /* 按钮 */
    .custom-open-button {
      height: 40px;
      background: linear-gradient(90deg, #61be33, #8fce44);
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: .3s;
      text-shadow: 1px 1px 5px #666666;
      filter: grayscale(0);
      margin-top: 10px;
    }

    .custom-open-button .text {
      font-size: 18px;
      color: #ffffff;
      letter-spacing: 1px;
      display: block;
      margin-bottom: 0;
      line-height: 1;
    }

    .custom-open-button.disabled {
      filter: grayscale(1);
    }

    .custom-open-button.disabled .text {
      display: none;
    }

    .custom-open-button.disabled .button__loading {
      display: flex;
    }

    .button__loading {
      height: 10px;
      display: none;
    }

    .button__loading span {
      display: block;
      width: 10px;
      height: 100%;
      margin: 0 5px;
      border-radius: 50%;
      background: lightgreen;
      animation: load 1.04s ease infinite;
    }

    @-webkit-keyframes load {
      0% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    .button__loading span:nth-child(1) {
      -webkit-animation-delay: 0.13s;
    }

    .button__loading span:nth-child(2) {
      -webkit-animation-delay: 0.26s;
    }

    .button__loading span:nth-child(3) {
      -webkit-animation-delay: 0.39s;
    }

    .button__loading span:nth-child(4) {
      -webkit-animation-delay: 0.52s;
    }

    .button__loading span:nth-child(5) {
      -webkit-animation-delay: 0.65s;
    }

    /* 隐藏不需要的表单 */
    .hide-option {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- 提交表单 -->
  <div id="extendForm"></div>

  <!-- 打开按钮 -->
  <div id="customOpenButton" class="custom-open-button disabled">
    <p class="text">CUSTOM</p>
    <div class="button__loading">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <!-- <div id="app">
    <minime/>
  </div>
   -->
  <script type="module">
    import { product } from './shopifyPageConfig.js';

    // 全局配置
    const plugType = "PLUG_INTERCEPTION_HEAD_NEW";
    const website = "TEST";
    // const product = {{ product | json }};
    console.log('产品的type：', product.type);

    /**************************************
     ***************** Vue ****************
     **************************************/
    // 添加app节点到body上
    $('body').append('<div id="app"></div>');
    // 实列
    const app = Vue.createApp({
      data() {
        return {
          config: {},
          visible: false,
          loaded: false
        }
      },

      watch: {
        visible(val) {
          if (val) {
            $("body").css('overflow', 'hidden');
          } else {
            $("body").css('overflow', 'auto');
          }
        }
      },

      async mounted() {
        this.setLoaded(false);
        this.config = await getConfig();
        this.setLoaded(true);
        this.setInitOption(this.config.increment);
        this.bindOpenButton();
        this.hideDefaultButton();
      },

      methods: {
        // 设置加载完成
        setLoaded(flag) {
          this.loaded = flag;
          this.disabledOpenButton(flag);
        },

        // 设置初始化选项
        setInitOption(increment) {
          if (increment.slides) {
            changeVariant('Type', 'single');
          }
        },

        // 完成
        async complete(data) {
          $('#extendForm').empty();
          this.setExtendForm(data.files);
          await this.dealIncrement(data.increment);
          $('.product-form__cart-submit').trigger('click');
        },

        // 设置扩展表单属性
        setExtendForm(files) {
          const map = {
            ai: 'Ai',
            preview: 'Preview',
            raw: 'Original'
          }

          for (let i in files) {
            const value = files[i];
            const name = map[i];
            const $input = $(`<input type="hidden" name="properties[${name}]"></input>`);
            $input.val(value);
            $('#extendForm').append($input);
            this.visible = false;
          }

          const $input = $(`<input type="hidden" name="properties[visibleKey]"></input>`);
          $input.val('Preview');
          $('#extendForm').append($input);
        },

        // 处理扩展信息
        dealIncrement(data) {
          const { slides, relatedProduct, vip } = data;
          const queue = [];

          if (slides) {
            queue.push(this.changeSKU('Type', slides));
          }

          if (vip) {
            queue.push(this.addVIP(vip));
          }

          if (relatedProduct) {
            queue.push(this.addRelatedProduct(relatedProduct));
          }
          return new Promise((resolve) => {
            Promise.all(queue).then(() => {
              resolve();
            });
          })
        },

        // 修改SKU，改变价格
        changeSKU(type, value) {
          return new Promise((resolve) => {
            changeVariant(type, value);
            resolve();
          })
        },

        // 添加vip
        async addVIP(data) {
          // 添加主商品字段
          const value = this.getRandomID();
          const $input = $(`<input type="hidden" name="properties[_tempVip]"></input>`);
          $input.val(value);
          $('#extendForm').append($input);
          // 加入购物车
          await this.addToCart({
            id: data.virtualId,
            quantity: 1,
            "properties[_tempVip]": value,
            mask: 'body',
            refresh: true,
          })
          return Promise.resolve();
        },

        // 添加附加商品
        async addRelatedProduct(data) {
          // 添加主商品字段
          const value = this.getRandomID();
          const $input = $(`<input type="hidden" name="properties[_related_product]"></input>`);
          $input.val(value);
          $('#extendForm').append($input);
          // 加入购物车
          const product = data[0];
          await this.addToCart({
            id: product.virtualId,
            quantity: 1,
            "properties[Preview]": product.url,
            "properties[_related_product]": value,
            mask: 'body',
            refresh: true,
          });
          return Promise.resolve();
        },

        // 加入购物车
        addToCart(data) {
          return new Promise((resolve, reject) => {
            $.ajax({
              type: "POST",
              url: "/cart/add.js",
              data,
              async: false,
              dataType: "json",
              context: this,
              success: res => {
                resolve(res)
              },
              error: (request, status) => {
                reject(request, status);
              }
            })
          })
        },

        // 随机ID
        getRandomID(length = 8) {
          return Number(Math.random().toString().substr(3, length) + Date.now()).toString(36);
        },

        // 绑定点击事件
        bindOpenButton() {
          $("#customOpenButton").click(() => {
            if (this.loaded) {
              const sku = $(".variant-sku").text();
              const price = product.variants.find(item => item.sku === sku).price;
              this.config.productPrice = `$${(price / 100)}`;
              this.config.productTitle = product.title;
              this.visible = true;
            }
          })
        },

        // 设置按钮可点击
        disabledOpenButton(flag) {
          if (flag) {
            $("#customOpenButton").removeClass('disabled');
          } else {
            $("#customOpenButton").addClass('disabled');
          }
        },

        // 隐藏默认按钮
        hideDefaultButton() {
          $('.product-form__item--submit').hide();
          $('.confirm-payment-button').hide();
          $('.product-vip-gift-box-div').hide();
        }

      },

      render() {
        if (this.loaded && this.visible) {
          return Vue.h(
            MinimePillow,
            {
              config: this.config,
              onClose: () => {
                this.visible = false;
              },
              onComplete: this.complete
            }
          )
        }
      }
    })

    // 挂载到app上
    app.mount('#app');


    /*****************************************
     ***************** 通用方法 ***************
     *****************************************/
    // 获取配置参数
    function getConfig() {
      let config = {};
      const url = `https://sc.globaladput.com/plugins/api/v1/configure?webSite=${website}&plugType=${plugType}`;

      return new Promise((resolve, reject) => {
        $.ajax(url, {
          success: res => {
            const { status, data } = res;
            if (status === '0') {
              const configItem = data[0] || {};
              if (!configItem) {
                return;
              }
              config = JSON.parse(configItem.configure);
              config.website = website;
              config.increment = getIncrement(product.type, config);

              let currentItem = {};
              for (let i = 0; i < config.miniMeData.length; i++) {
                const group = config.miniMeData[i];
                for (let j = 0; j < group.images.length; j++) {
                  const image = group.images[j];
                  if (String(image.id) === String(getTagID())) {
                    currentItem = image;
                  };
                }
              }
              const firstGroup = config.miniMeData[0];
              firstGroup.images.unshift(currentItem);

              resolve(config);
            }
          },
          error: msg => {
            reject(msg);
          }
        })
      })
    }

    // 获取当前增量
    function getIncrement(type, config) {
      const typeItem = config.incrementMap.find(item => item.productType === type);
      const modules = typeItem ? typeItem.modules : [];
      const increment = config.increment;
      const obj = {};
      Object.keys(increment).forEach(key => {
        if (modules.includes(key)) {
          obj[key] = increment[key];
        }
      })
      return obj;
    }

    // 修改SKU
    function changeVariant(key, value) {
      value = value === 'double' ? "Double Side" : "Single Side";
      $(".product-form").find(".selector-wrapper").each(function () {
        const title = $(this).find('label').text().trim();
        let optionTitle = title;
        if (title.includes('?')) {
          optionTitle = title.split('?')[0];
        } else if (title.includes(':')) {
          optionTitle = title.split(':')[0];
        }

        if (optionTitle === key) {
          $(this).find('.single-option-selector').val(value).trigger('change');
        }
      });
    }

    // 获取当前TagID
    function getTagID() {
      var tags = "{{ product.tags | join:',' }}";
      var optionResult = tags.match(/mini-me-default-\d+/);
      var _number = optionResult && Number(optionResult[0].split("-").pop());
      return isNaN(_number) ? "" : _number;
    }
  </script>
</body>

</html>